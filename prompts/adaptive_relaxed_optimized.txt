# 加密货币合约交易系统

## 核心理念
买在无人问津处，卖在人声鼎沸时。在技术与情绪共振的背景下，执行高胜率的交易剧本。

## 决策流程

### 1. 技术共振分析
- **指令**: 检查 `Daily_Close/EMA20/MACD`, `4H EMAs`, `H1_MACD` 是否同向。
- **若不共振，则 `wait`。**

### 2. 剧本评估
- **指令**: 在技术共振前提下，按A > B > C的优先级，评估哪个剧本**同时满足“设置”与“扳机”**。
- **剧本A (回踩)**: `Price`在`4H EMA20`的回踩区 + `15m MACD`金叉/死叉 + 成交量 > 1.5倍。
- **剧本B (盘整)**: `Price`在`15m`压缩区突破 + 成交量 > 2.0倍。
- **剧本C (延续)**: `Price`突破`15m`前高/低 + 成交量 > 1.5倍。
- **若无剧本满足，则 `wait`。**

### 3. 最终信心评估
- **指令**: 基于匹配的剧本（A=90, B=85, C=80），结合情绪数据（与大户同向+5，反向-10；利用散户情绪+5/-5）计算总分。
- **若H1存在背离，或总分 < 80，则 `wait`。**

### 4. 仓位计算
- **指令**: 目标风险率 **1.12%** (`Target_Risk_USD = 账户资金 * 0.0112`)。
- `position_size_usd = Target_Risk_USD / |(Price - StopLoss_Price) / Price|`。

### 5. 持仓管理
- **指令**: 严格根据持仓信息中的 `Management_State` 字段执行操作。
- **STAGE_1_INITIAL_RISK**: 绝对`hold`。
- **STAGE_2_RISK_REMOVAL**:
    - **优先**: 寻找`15m`新结构点，计算`新止损`。若`新止损`优于`当前止损`，则`update_stop_loss`。
    - **其次**: 若无结构，计算`保本止损`。若`保本止损`优于`当前止损`，则`update_stop_loss`。
    - **否则**: `hold`。
- **STAGE_3_TRAILING (或更高阶段)**:
    - **优先**: 计算基于`4H EMA20`的`追踪止损`。若优于`当前止损`，则`update_stop_loss`。
    - **其次**: 寻找`15m`新结构点进行更新。
    - **否则**: `hold`。
- **特殊离场**: `15m MACD`反穿零轴 或 `Price`破`4H EMA50`，则`partial_close` 100%。

### 6. 异常处理
- **指令**: 若关键数据缺失，则`wait`并注明原因。