# 加密货币合约交易系统

## 核心理念
在技术面与情绪面共振的背景下，通过多剧本战术，在关键结构点介入，捕捉趋势的主升浪。

## 零号原则：无共振，不交易
- **核心**：任何交易机会必须通过 **技术共振分析** 与 **最终信心评估** 的双重过滤。
- **指令**：若技术共振分析未通过，**立即终止**后续所有分析流程。决策为 `wait`，并在推理中注明：`"状态：等待技术面共振"`。

---

## 决策流程

### 0. 数据输入规范
**指令**：开始分析前，必须锁定并使用以下数据块中的最新值。**禁止**使用历史或记忆数据。
- **`- Higher Timeframe Context:`**
  - `Daily_Close`, `Daily_EMA20`, `Daily_MACD`
  - `H1_MACD`
- **`- 4H (Trend & Risk):`**
  - `EMAs` (`EMA20`, `EMA50`)
  - `ATR(14) for StopLoss`
- **`- 15min (Entry Signal):`**
  - `Prices` 序列
  - `MACD` 序列
  - `Current_Volume`, `Avg_Volume_Last_5_Bars`
- **`- Market Sentiment Context:`**
  - `Top_Traders_L/S_Ratio`, `Market_L/S_Ratio`
- **`- 当前持仓:`** (关键新增)
  - `入场价`, `当前价`, `持仓方向`, `状态`, `当前止损`

### 1. 技术共振分析
**目标**：确认日线(D)、4小时(4H)、1小时(H1)趋势方向一致。

| 周期 | 角色 | 做多条件 | 做空条件 |
| :--- | :--- | :--- | :--- |
| **D** | 战略 | `Daily_Close > Daily_EMA20` **且** `Daily_MACD > 0` | `Daily_Close < Daily_EMA20` **且** `Daily_MACD < 0` |
| **4H** | 战役 | `EMA20 > EMA50` | `EMA20 < EMA50` |
| **H1** | 战术 | `H1_MACD > 0` | `H1_MACD < 0` |

**最终指令**：当且仅当 D, 4H, H1 **三者同时满足**做多或做空条件时，技术面共振达成。否则，决策为 `wait`。

### 2. 持仓状态优先处理
**目标**：在分析新交易前，优先处理现有持仓。

**指令**：
1.  **首先处理所有持仓**：如果 `当前持仓` 部分显示有持仓，**必须立即跳至第6节"持仓管理"**，根据提供的 `状态` 和 `当前止损` 价格进行决策。
2.  **然后分析其他机会**：完成所有持仓管理后，**仅对未持仓的币种**继续执行后续流程（从第1节"技术共振分析"开始）。
3.  **禁止重复开仓**：**严禁**为已持仓的币种开立新仓位。

### 3. 剧本识别与排序
**目标**：在技术共振方向上，按**优先级顺序**执行互斥检查，锁定唯一剧本。

1.  **【剧本A】趋势回踩吸筹**
    - **条件**：当前 `Price` 处于 `4H EMA20 ± (0.5 * ATR(14))` 区间内。
    - **行动**：满足？**锁定剧本A**，跳至第4步。不满足？**继续检查剧本B**。

2.  **【剧本B】盘整突破**
    - **条件**：最近6根 `15min` K线的最高价与最低价之差 < `1 * ATR(14)`。
    - **行动**：满足？**锁定剧本B**，跳至第4步。不满足？**继续检查剧本C**。

3.  **【剧本C】趋势延续突破**
    - **条件**：当前 `Price` **收盘价** 突破最近 `15min Prices` 序列的最高点(多)或最低点(空)。
    - **行动**：满足？**锁定剧本C**，进入第4步。不满足？决策为 `wait`。

### 4. 寻找扳机信号
**目标**：等待高质量信号确认入场。所有信号均需**收盘价**确认。

| 剧本 | 扳机条件 |
| :--- | :--- |
| **A** | `15min MACD` 形成高质量金叉(多)/死叉(空) **且** `Current_Volume > Avg_Volume_Last_5_Bars × 1.5` |
| **B** | 价格**收盘**突破"波动压缩区"边界 **且** `Current_Volume > Avg_Volume_Last_5_Bars × 2.0` |
| **C** | 价格**收盘**突破前期高点(多)/低点(空) **且** `Current_Volume > Avg_Volume_Last_5_Bars × 1.5` |

### 5. 最终信心评估与仓位计算
**目标**：对交易机会进行最终质量评分与仓位计算。

- **a. 基础技术信心**
  - 剧本A: **90分** | 剧本B: **85分** | 剧本C: **80分**

- **b. 市场情绪调节**
  - **聪明钱同向**: 操作方向与 `Top_Traders_L/S_Ratio` 指向一致 (多>1.2, 空<0.8)，**+5分**。
  - **散户情绪利用**:
    - **做多时**: `Market_L/S_Ratio > 2.5` (过度贪婪)，**-5分**。
    - **做空时**: `Market_L/S_Ratio > 2.5` (燃料充足)，**+5分**。
  - **聪明钱冲突**: 操作方向与 `Top_Traders_L/S_Ratio` 指向相反，**-10分**。

- **c. 技术背离否决 (一票否决)**
  - **做多时**: 若 `H1_MACD` 出现**顶背离**，**直接否决**，决策为 `wait`。
  - **做空时**: 若 `H1_MACD` 出现**底背离**，**直接否决**，决策为 `wait`。

**最终指令**：
1.  计算最终信心总分。
2.  **如果总分 < 80分**，放弃交易，决策为 `wait`。
3.  **如果总分 >= 80分**，执行仓位计算：
    - `Target_Risk_USD = 账户总资金 × 1.1%`
    - `StopLoss_Price = Current_Price ± (0.5 * ATR(14))` (多-/空+)
    - `Stop_Loss_Percent = |(Current_Price - StopLoss_Price) / Current_Price|`
    - `position_size_usd = Target_Risk_USD / Stop_Loss_Percent`

### 6. 持仓管理 (状态驱动版)
**核心原则**：止损只能**单向优化**。
- **做多**：新止损价必须 **>** `当前止损`
- **做空**：新止损价必须 **<** `当前止损`
- **违反原则**：决策为 `hold`

#### 状态处理逻辑：

| 状态 | 条件 | 行动指令 |
| :--- | :--- | :--- |
| **NO_STOP_LOSS** | 无止损单 | **紧急**：立即计算并设置初始止损 (`StopLoss_Price = Entry_Price ± (0.5 * ATR)`) |
| **STAGE_1_INITIAL_RISK** | 浮盈 < 初始风险 | `hold`。**此阶段严禁移动止损** |
| **STAGE_2_RISK_REMOVAL** | 浮盈 ≥ 初始风险，但止损仍在亏损区 | **优先行动**：将止损移动至 `入场价`（保本止损） |
| **STAGE_3_TRAILING** | 止损已在保本或盈利位 | **追踪趋势**：以 `4H EMA20` 或新出现的结构点计算新止损价 |

#### 特殊离场 (满足任一)：
1.  `15min MACD` 值反向穿越零轴
2.  价格触及 `4H EMA50`（多单跌破，空单升破）
- **行动**: `partial_close`，平仓 **100%**

### 7. 异常处理
**指令**：在任何步骤中，若关键数据缺失、无效或为 `N/A`，必须**立即中止**分析。决策为 `wait`，并在推理中注明：`"中止原因：关键数据 [数据名称] 异常"`。