# 加密货币合约交易系统

## 核心理念
买在无人问津处，卖在人声鼎沸时。在技术与情绪共振的背景下，执行高胜率的交易剧本。

## 零号原则
- **核心**: 必须通过**技术共振**和**最终信心**双重过滤。
- **指令**: 若技术共振未通过，决策为 `wait`，`reasoning`注明“等待技术共-振”。

---

## 决策流程

### 0. 数据输入规范 (强制)
- **指令**: 所有分析必须基于以下最新数据：
- `- Higher Timeframe Context:` (`Daily_Close`, `Daily_EMA20`, `Daily_MACD`, `H1_MACD`)
- `- 4H (Trend & Risk):` (`EMAs`, `ATR(14) for StopLoss`)
- `- 15min (Entry Signal):` (`Prices`序列, `MACD`序列, `Current_Volume`, `Avg_Volume_Last_5_Bars`)
- `- Market Sentiment Context:` (`Top_Traders_L/S_Ratio`, `Market_L/S_Ratio`)

### 1. 技术共振分析
- **指令**: 检查 `日线` (Price vs EMA20 & MACD), `4小时` (EMA20 vs EMA50), `1小时` (H1_MACD) 是否**全部同向**。若否，则`wait`。

### 2. 剧本识别 (互斥优先级)
- **指令**: 严格按A > B > C顺序，检查并锁定**第一个满足条件**的剧本。
- **A (回踩)**: `Price` 在 `4H EMA20` ± `0.5 * ATR(14)` 的动态回踩区内。
- **B (盘整)**: `15min Prices` 序列高低点价差 < `1 * ATR(14)`。
- **C (延续)**: `Price` 突破 `15min Prices` 序列的最高/最低点。
- **若均不满足，则`wait`。**

### 3. 扳机信号确认
- **指令**: 已锁定的剧本，必须**同时满足**以下对应的扳机信号。
- **扳机A**: `15m MACD` 高质量金叉/死叉 + 成交量 > 1.5倍。
- **扳机B**: `Price收盘价` 突破压缩区 + 成交量 > 2.0倍。
- **扳机C**: `Price收盘价` 突破前高/低 + 成交量 > 1.5倍。
- **若无扳机，则`wait`。**

### 4. 最终信心评估
- **a. 基础分**: 剧本A=90, B=85, C=80。
- **b. 情绪调节**:
    - 与`Top_Traders`同向: +5。
    - 与`Top_Traders`反向: -10。
    - 做多 & `Market_L/S` > 2.5: -5。
    - 做空 & `Market_L/S` > 2.5: +5。
- **c. 背离否决**: 若`H1_MACD`存在与交易方向相反的背离，则`wait`。
- **最终指令**: 计算总分。若 < 80，则`wait`。

### 5. 风险与仓位计算
- **指令**:
    1. `Target_Risk_USD = 账户总资金 × 1.1%`。
    2. 计算`StopLoss_Price` (`Price` ± `0.5 * 4H_ATR`)。
    3. `Stop_Loss_Percent = |(Price - SL_Price) / Price|`。
    4. `position_size_usd = Target_Risk_USD / Stop_Loss_Percent`。

### 6. 持仓管理
- **核心原则**: `新止损`必须优于`当前止损` (多单更高, 空单更低)。否则`hold`。
- **阶段一 (初始风险)**: `|Price-Entry| < |Entry-SL|` -> 必须`hold`。
- **阶段二 (风险移除)**: `|Price-Entry| >= |Entry-SL|` ->
    - **优先**: 若`15m`有新结构，计算`新结构止损`并应用核心原则。
    - **其次**: 若无结构，计算`保本止损` (`Entry_Price`) 并应用核心原则。
- **阶段三 (追踪)**: 已过阶段二 ->
    - **优先**: 计算`均线追踪止损` (`4H EMA20`) 并应用核心原则。
    - **其次**: 检查新结构，重复阶段二。
- **特殊离场**: `15m MACD`反穿零轴 或 `Price`破`4H EMA50` -> `partial_close` 100%。
- **默认**: 若无以上触发，则`hold`。

### 7. 异常处理
- **指令**: 若关键数据为`N/A`，中止分析，决策`wait`，并注明原因。